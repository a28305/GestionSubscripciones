version: '3.9'

services:

  # 1. Servicio de la API (Usuario 28305 -> Puerto 8305)
  api:
    image: gestionsuscripciones_api
    container_name: dotnet_apicontainer
    # Si vas a usar 'docker compose up --build', descomenta estas l칤neas:
    # build:
    #   context: .
    #   dockerfile: Dockerfile
      
    # Puertos: 8305 (Usuario) -> 8080 (Interno .NET 8)
    ports:
      - "8305:8080"
    environment:
      # Forzamos el puerto de escucha de Kestrel (necesario para contenedores)
      - ASPNETCORE_URLS=http://+:8080
      - ASPNETCORE_ENVIRONMENT=Development
      
      # 游눠 CORRECCI칍N CR칈TICA: Cadena de conexi칩n sin comillas.
      # Usamos el nombre del servicio SQL Server (sqlserver)
      - ConnectionStrings__GestionServiceDB=Server=sqlserver;Database=GestionServiceDB;User Id=sa;Password=P@sswOrd2025!;
      
      # Funcionalidad Extra: Versi칩n de la API (Si la usas en Program.cs)
      - API_VERSION=1.0.0-PROD-CONTAINERIZED
      
    depends_on:
      - sqlserver
    networks:
      - backend
    restart: unless-stopped

  # 2. Servicio de la Base de Datos SQL Server (Invertido -> Puerto 5038)
  sqlserver:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: sqlserver
    # Puertos: 5038 (Invertido) -> 1433 (Est치ndar SQL Server)
    ports:
      - "5038:1433"
    environment:
      - ACCEPT_EULA=Y
      # Contrase침a del servidor, DEBE COINCIDIR con la cadena de conexi칩n de arriba
      - MSSQL_SA_PASSWORD=P@sswOrd2025!
      - MSSQL_PID=Express
    volumes:
      - sqlserver_data:/var/opt/mssql
    networks:
      - backend
    restart: unless-stopped

  # 3. Servicio Nginx (Proxy Inverso)
  nginx:
    image: nginx:latest
    container_name: nginxcontainer
    # Puerto HTTP est치ndar
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - api
    networks:
      - backend
      - frontend 
    restart: unless-stopped

  # 4. Servicio Redis
  redis:
    image: redis:latest
    container_name: redis3
    ports:
      - "6379:6379"
    networks:
      - backend
    restart: unless-stopped

networks:
  backend:
  frontend:

volumes:
  sqlserver_data: